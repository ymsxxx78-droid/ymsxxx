<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>수능 영어 압박훈련 — 무조건 공부해</title>
  <style>
    :root{
      --bg:#0b0b0d; --panel:#121216; --panel2:#16171c; --ink:#e9e9f2; --sub:#a9a9b8;
      --accent:#ff1f4b; --accent2:#ff922b; --ok:#2fcf6c; --warn:#ffd43b; --mut:#2a2a33;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:radial-gradient(1200px 600px at 10% -10%, #1b1b21 0%, #0b0b0d 45%), linear-gradient(180deg,#0b0b0d,#0a0a0b);color:var(--ink)}
    header{position:sticky;top:0;background:rgba(10,10,11,.8);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid #20202a;z-index:10}
    .wrap{max-width:1180px;margin:0 auto;padding:18px 20px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(145deg,#ff1f4b,#8a1237);display:grid;place-items:center;box-shadow:0 6px 24px rgba(255,31,75,.35)}
    .logo b{font-size:22px}
    h1{margin:0;font-size:22px;letter-spacing:.5px}
    .punch{font-weight:800;color:var(--accent);text-transform:uppercase}
    nav{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    nav button{border:1px solid #2a2a33;background:linear-gradient(#1a1b20,#15161a);color:#d9d9e6;padding:10px 14px;border-radius:12px;cursor:pointer}
    nav button[aria-current="page"]{border-color:var(--accent);box-shadow:0 0 0 1px rgba(255,31,75,.35) inset;color:#fff}

    .grid{display:grid;grid-template-columns:300px 1fr;gap:16px;margin-top:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    aside{background:linear-gradient(180deg,#121216,#0f0f13);border:1px solid #20202a;border-radius:14px;padding:14px}
    aside h3{margin:4px 0 10px 0;font-size:14px;color:#c9c9d6;opacity:.9}
    .card{background:linear-gradient(180deg,#14141a,#101015);border:1px solid #1f1f29;border-radius:16px;padding:18px}
    .card h2{margin:0 0 8px 0}
    .mut{color:var(--sub);font-size:14px}
    .danger{color:var(--accent)}
    .ok{color:var(--ok)}
    .kbd{padding:2px 6px;border:1px solid #2a2a33;border-radius:6px;background:#0c0c10;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}

    .controls{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
    .controls > *{border-radius:10px;border:1px solid #2a2a33;background:#0f0f13;color:#e6e6f2;padding:8px 10px}
    .controls input[type="number"], .controls input[type="text"]{width:120px}

    .big{font-size:28px;font-weight:900;letter-spacing:.2px}
    .strike{display:inline-block;position:relative}
    .strike::after{content:"";position:absolute;left:-3px;right:-3px;top:55%;height:4px;background:linear-gradient(90deg,transparent, var(--accent), transparent)}

    .btn{cursor:pointer;user-select:none}
    .btn.primary{background:linear-gradient(180deg,#2a0d14,#1a0a0e);border-color:#3a0f17;color:#ffdce4}
    .btn.primary:hover{filter:brightness(1.06)}
    .btn.ghost{background:#0c0c10;border-color:#252530;color:#cfcfe0}

    .stack{display:grid;gap:12px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    .progress{height:10px;border:1px solid #2a2a33;border-radius:12px;background:#0d0d11;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#ff1f4b,#ff922b)}

    .quiz{display:grid;gap:14px}
    .opt{border:1px solid #2a2a33;background:#0f0f13;padding:12px;border-radius:12px;cursor:pointer}
    .opt.correct{border-color:rgba(47,207,108,.8);box-shadow:0 0 0 1px rgba(47,207,108,.25) inset}
    .opt.wrong{border-color:rgba(255,31,75,.8);box-shadow:0 0 0 1px rgba(255,31,75,.25) inset}

    .pill{display:inline-flex;align-items:center;gap:8px;border:1px dashed #2a2a33;padding:6px 10px;border-radius:999px;background:#0d0d11}
    .tiny{font-size:12px;color:#a9a9b8}

    footer{margin:40px 0;color:#81819a}
    code{background:#0f0f13;border:1px solid #252530;border-radius:6px;padding:2px 6px}
    textarea{width:100%;min-height:120px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo"><b>⚡</b></div>
        <div>
          <h1><span class="punch">수능 영어 압박훈련</span> — <span class="strike">핑계</span> 금지. 무조건 공부해.</h1>
          <div class="mut">타깃: 고1 남학생 | 분위기: 강력·강제·엄함 | 모토: "오늘 안 하면 내일의 너가 운다"</div>
        </div>
      </div>
      <nav aria-label="섹션">
        <button class="tab btn" data-tab="mem">단어 암기</button>
        <button class="tab btn" data-tab="test">단어 테스트</button>
        <button class="tab btn" data-tab="sent">문장 예시</button>
        <button class="tab btn" data-tab="rc">독해 생성</button>
        <button class="tab btn" data-tab="log">학습 기록</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <aside>
        <h3>학습 세팅</h3>
        <div class="stack">
          <label class="row">덱 사이즈
            <input id="deckSize" type="number" min="5" value="20" />
          </label>
          <label class="row">보기 개수
            <input id="choiceSize" type="number" min="2" max="6" value="4" />
          </label>
          <div class="row">
            <button class="btn ghost" id="shuffleBtn">섞기</button>
            <button class="btn ghost" id="resetBtn">초기화</button>
          </div>
          <div class="progress"><div class="bar" id="progBar"></div></div>
          <div id="status" class="tiny">오늘의 진도 0%</div>
        </div>
        <hr style="border-color:#23232e;border-style:solid;border-width:1px 0 0;margin:14px 0">
        <h3>단어장 불러오기</h3>
        <p class="tiny">※ 저작권 보호를 위해 <b>워드마스터 수능 2000</b> 전체 목록은 포함하지 않았습니다. 아래에 붙여넣거나 CSV 업로드로
          <span class="pill">영단어,의미</span> 형식 데이터를 추가하세요.</p>
        <div class="stack">
          <input type="file" id="fileInput" accept=".csv,.txt" />
          <textarea id="pasteBox" placeholder="ex) abandon,버리다/포기하다\naccount,설명하다/간주하다 ..."></textarea>
          <button class="btn primary" id="importBtn">가져오기/병합</button>
          <div class="tiny" id="importMsg"></div>
        </div>
        <hr style="border-color:#23232e;border-style:solid;border-width:1px 0 0;margin:14px 0">
        <h3>규칙</h3>
        <ul class="tiny">
          <li>오답 1회 → 그 자리에서 <b class="danger">즉시 복습</b></li>
          <li>스코어가 낮으면 <b class="danger">압박 메시지</b> 표시</li>
          <li>연속 정답은 <b class="ok">콤보 보너스</b>로 저장</li>
        </ul>
      </aside>

      <section id="view">
        <!-- 단어 암기 -->
        <div class="card" data-view="mem">
          <h2>단어 암기 — <span class="punch">보는 즉시 외워</span></h2>
          <p class="mut">플래시카드 모드. 좌/우 ← → 또는 버튼으로 이동.</p>
          <div class="stack">
            <div class="row" style="justify-content:space-between">
              <div class="pill">현재 <b id="fcIdx">1</b>/<b id="fcTotal">-</b></div>
              <div class="row">
                <button class="btn ghost" id="prev">← 이전</button>
                <button class="btn ghost" id="flip">의미 보기/숨기기</button>
                <button class="btn ghost" id="next">다음 →</button>
              </div>
            </div>
            <div class="card" style="text-align:center;background:#0e0e12;border-style:dashed">
              <div id="fcFront" class="big" style="margin:10px 0 6px">abandon</div>
              <div id="fcBack" class="mut" style="font-size:20px;display:none">버리다, 포기하다</div>
            </div>
            <div class="row">
              <button class="btn primary" id="markEasy">알았다(콤보+)</button>
              <button class="btn ghost" id="markHard">애매함(후순위 반복)</button>
            </div>
          </div>
        </div>

        <!-- 단어 테스트 -->
        <div class="card hidden" data-view="test">
          <h2>단어 테스트 — <span class="punch">틀리면 반복</span></h2>
          <div class="row" style="gap:20px">
            <div class="pill">점수 <b id="score">0</b></div>
            <div class="pill">콤보 <b id="combo">0</b></div>
            <div class="pill">틀린단어 <b id="wrongs">0</b></div>
          </div>
          <div class="quiz" id="quiz"></div>
          <div id="taunt" class="mut"></div>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" id="nextQ">다음 문제</button>
            <button class="btn ghost" id="retryWrong">오답 재도전</button>
          </div>
        </div>

        <!-- 문장 예시 -->
        <div class="card hidden" data-view="sent">
          <h2>문장 예시 — <span class="punch">단어를 문장에 박아라</span></h2>
          <div class="controls">
            <input id="sentWord" type="text" placeholder="영단어 입력 (ex. abandon)" />
            <button class="btn primary" id="genSent">생성</button>
          </div>
          <div id="sentences" class="stack"></div>
          <p class="tiny">Tip: 암기 단어를 클릭하면 자동 채워집니다.</p>
        </div>

        <!-- 독해 생성 -->
        <div class="card hidden" data-view="rc">
          <h2>독해 생성 — <span class="punch">단어를 던져. 지문이 따라온다</span></h2>
          <div class="controls">
            <input id="rcWord" type="text" placeholder="영단어 입력 (ex. abandon)" />
            <input id="rcLen" type="number" min="60" value="120" />
            <label class="tiny">지문 길이(단어수 대략)</label>
            <button class="btn primary" id="genRC">지문 생성</button>
          </div>
          <div id="rcPassage" class="stack"></div>
        </div>

        <!-- 학습 기록 -->
        <div class="card hidden" data-view="log">
          <h2>학습 기록 — <span class="punch">변명보다 데이터</span></h2>
          <div id="history" class="stack"></div>
          <div class="row">
            <button class="btn ghost" id="exportBtn">내보내기(JSON)</button>
            <button class="btn ghost" id="clearLog">기록 삭제</button>
          </div>
        </div>
      </section>
    </div>

    <footer>
      <p class="tiny">© 압박훈련 — 로컬에서만 작동. 학습 데이터는 브라우저 <code>localStorage</code>에 저장됩니다. | <b class="danger">워드마스터 수능 2000 원문 데이터는 포함되어 있지 않습니다.</b></p>
    </footer>
  </main>

  <script>
    // -----------------------------
    // Minimal 샘플 단어 — 전체 단어는 직접 가져오기
    // 형식: {en:'word', ko:'의미'}
    const SAMPLE_WORDS = [
      {en:'abandon', ko:'버리다/포기하다'},
      {en:'account', ko:'설명하다/간주하다'},
      {en:'accuse', ko:'비난하다/고발하다'},
      {en:'adapt', ko:'적응하다/개작하다'},
      {en:'adhere', ko:'고수하다/부착하다'},
      {en:'affect', ko:'영향을 미치다/감동시키다'},
      {en:'alter', ko:'바꾸다/변하다'},
      {en:'anticipate', ko:'예상하다'},
      {en:'approve', ko:'승인하다/찬성하다'},
      {en:'assert', ko:'주장하다/단언하다'},
      {en:'attain', ko:'달성하다/이르다'},
      {en:'ban', ko:'금지하다'},
      {en:'breed', ko:'새끼를 낳다/기르다'},
      {en:'cease', ko:'그만두다/중지하다'},
      {en:'ceiling', ko:'천장/상한선'},
      {en:'concise', ko:'간결한'},
      {en:'confer', ko:'수여하다/상의하다'},
      {en:'decline', ko:'거절하다/감소하다'},
      {en:'derive', ko:'유래하다/얻다'},
      {en:'deter', ko:'단념시키다/막다'}
    ];

    // -----------------------------
    // State & Storage
    const LS_KEY = 'suneung_drill_v1';
    const state = {
      words: [],
      deck: [],
      idx: 0,
      score: 0,
      combo: 0,
      wrongs: [],
      history: JSON.parse(localStorage.getItem(LS_KEY) || '{"sessions":[]}')
    };

    function saveHistorySession(extra={}){
      const entry = {
        ts: new Date().toISOString(),
        score: state.score,
        combo: state.combo,
        wrongs: state.wrongs.length,
        deckSize: state.deck.length,
        ...extra
      };
      state.history.sessions.push(entry);
      localStorage.setItem(LS_KEY, JSON.stringify(state.history));
      renderHistory();
    }

    // -----------------------------
    // UI helpers
    const $$ = (sel,root=document)=>root.querySelector(sel);
    const $$$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
    function setTab(name){
      $$$('nav .tab').forEach(b=>{
        const on = b.dataset.tab===name; b.setAttribute('aria-current', on? 'page': 'false');
      });
      $$$('[data-view]').forEach(v=>v.classList.toggle('hidden', v.dataset.view!==name));
    }

    // Progress
    function updateProgress(){
      const cur = state.idx+1; const total = state.deck.length || 1;
      $$('#fcIdx').textContent = cur; $$('#fcTotal').textContent = total;
      const ratio = Math.max(0, Math.min(1, cur/total));
      $$('#progBar').style.width = (ratio*100)+'%';
      $$('#status').textContent = `오늘의 진도 ${Math.round(ratio*100)}%`;
    }

    // Flashcards
    function showCard(){
      if(!state.deck.length){ $$('#fcFront').textContent='단어장이 비었습니다. 가져오기를 사용하세요.'; $$('#fcBack').style.display='none'; return; }
      const w = state.deck[state.idx];
      $$('#fcFront').textContent = w.en;
      $$('#fcBack').textContent = w.ko;
      $$('#fcBack').style.display='none';
      updateProgress();
    }

    // Import
    function parseCSV(text){
      const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const items = [];
      for(const ln of lines){
        const sep = ln.includes(',') ? ',' : (ln.includes('\t') ? '\t' : (ln.includes(';') ? ';' : null));
        if(!sep) continue; // 구분자가 없으면 건너뜀
        const [en,...rest] = ln.split(sep);
        if(!en||!rest.length) continue;
        const ko = rest.join(sep).trim();
        items.push({en:en.trim(), ko});
      }
      return items;
    }

    // 텍스트 인코딩/파일 형태 자동 판별 (UTF-8/UTF-16/EUC-KR 시도)
    async function readTextSmart(file){
      const buf = await file.arrayBuffer();
      const bytes = new Uint8Array(buf);
      // ZIP 시그니처: PK -> 주로 XLSX/DOCX
      if(bytes[0]===0x50 && bytes[1]===0x4B){
        throw new Error('엑셀(.xlsx/.docx) 파일로 보입니다. 반드시 CSV(.csv) 또는 UTF-8 텍스트(.txt)로 저장해 주세요.');
      }
      // BOM 체크
      if(bytes.length>=3 && bytes[0]===0xEF && bytes[1]===0xBB && bytes[2]===0xBF){
        return new TextDecoder('utf-8').decode(bytes);
      }
      if(bytes.length>=2 && bytes[0]===0xFF && bytes[1]===0xFE){
        return new TextDecoder('utf-16le').decode(bytes);
      }
      if(bytes.length>=2 && bytes[0]===0xFE && bytes[1]===0xFF){
        return new TextDecoder('utf-16be').decode(bytes);
      }
      // UTF-8 시도
      try { return new TextDecoder('utf-8', {fatal:true}).decode(bytes); } catch(e) {}
      // 한국어 CSV에서 흔한 EUC-KR 시도
      try { return new TextDecoder('euc-kr').decode(bytes); } catch(e) {}
      // 최후의 보루
      return new TextDecoder().decode(bytes);
    }

    function mergeWords(arr)(arr){
      // Deduplicate by 'en'
      const map = new Map();
      [...state.words, ...arr].forEach(w=>{
        map.set(w.en.toLowerCase(), {en:w.en.trim(), ko:w.ko.trim()});
      });
      state.words = Array.from(map.values());
      // Rebuild deck
      const deckSize = Math.max(1, parseInt($$('#deckSize').value||'20'));
      state.deck = shuffle(state.words).slice(0, deckSize);
      state.idx=0; state.score=0; state.combo=0; state.wrongs=[];
      $$('#score').textContent = '0'; $$('#combo').textContent='0'; $$('#wrongs').textContent='0';
      showCard();
      $$('#importMsg').textContent = `단어 ${state.words.length}개 (덱 ${state.deck.length}개) 준비 완료`;
    }

    // Shuffle
    function shuffle(a){
      const arr = a.slice();
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }

    // Test (MCQ)
    function makeQuestion(){
      if(!state.deck.length) return {stem:'단어를 먼저 가져오세요', options:[], answer:-1, word:null};
      const choiceSize = Math.max(2, Math.min(6, parseInt($$('#choiceSize').value||'4')));
      const w = state.deck[state.idx];
      const pool = shuffle(state.words).filter(x=>x.en!==w.en).slice(0, choiceSize-1).concat([w]);
      const options = shuffle(pool).map(x=>x.ko);
      const answer = options.indexOf(w.ko);
      return {stem:`${w.en} 의 뜻은?`, options, answer, word:w};
    }

    function renderQuiz(){
      const q = makeQuestion();
      const box = $$('#quiz');
      box.innerHTML = '';
      const stem = document.createElement('div'); stem.className='big'; stem.textContent=q.stem; box.appendChild(stem);
      q.options.forEach((txt,i)=>{
        const d=document.createElement('div'); d.className='opt'; d.textContent = `${i+1}. ${txt}`; d.onclick=()=>pick(i,q); box.appendChild(d);
      });
    }

    function taunt(){
      const msg = [
        '늦으면 무너진다. 지금 박아.',
        '집중. 휴대폰 멀리.',
        '틀렸으면 바로 복습. 변명 금지.',
        '넌 할 수 있다. 하지만 지금 당장 해라.'
      ];
      $$('#taunt').textContent = msg[Math.floor(Math.random()*msg.length)];
    }

    function pick(i,q){
      const opts = $$$('.opt');
      opts.forEach((el,idx)=>{
        if(idx===q.answer){ el.classList.add('correct'); }
        if(idx===i && i!==q.answer){ el.classList.add('wrong'); }
        el.style.pointerEvents='none';
      });
      if(i===q.answer){
        state.score+=10; state.combo+=1;
      } else {
        state.combo=0; state.wrongs.push(q.word); // push for retry
      }
      $$('#score').textContent = state.score;
      $$('#combo').textContent = state.combo;
      $$('#wrongs').textContent = state.wrongs.length;
      taunt();
    }

    // Sentences
    function sentenceTemplates(w){
      const en = w;
      const arr = [
        `No excuses—${en} your fear and start now.`,
        `He refused to ${en} his dream even when it was tough.`,
        `To succeed in the exam, you cannot ${en} your daily routine.`,
      ];
      const ko = [
        '변명 금지 — 두려움을 버리고 지금 시작해라.',
        '힘들어도 그는 꿈을 포기하지 않았다.',
        '수능에 성공하려면 일과를 포기해서는 안 된다.',
      ];
      return arr.map((s,i)=>({en:s, ko:ko[i]||''}));
    }

    // Reading Comprehension generator
    function makePassage(keyword,len=120){
      const pool = [
        `Students often ${keyword} their plans when pressure rises, but discipline means choosing consistency over mood.`,
        `In competitive sports and in test prep, routines guard you against chaos; habits are small decisions repeated.` ,
        `A mentor once said that success is boring: the same actions, every day, without ${keyword}.`,
        `When your motivation fades, systems remain; systems beat inspiration.`
      ];
      const words = [];
      while(words.join(' ').split(' ').length < len){
        words.push(pool[Math.floor(Math.random()*pool.length)]);
      }
      const passage = words.join(' ');
      // Questions
      const q1 = {type:'어휘', q:`문맥상 밑줄 친 ${keyword} 의 의미로 가장 가까운 것은?`, options:['maintain','postpone','abandon','decorate'], answer:2};
      const q2 = {type:'빈칸', q:'글의 주제로 가장 적절한 것은?', options:['규칙의 힘과 일관성','완벽주의의 장점','즉흥성의 가치','운의 중요성'], answer:0};
      const q3 = {type:'내용일치', q:'다음 중 글의 내용과 일치하지 <b>않는</b> 것은?', options:[
        '규칙적인 습관은 혼란을 막아준다.',
        '동기 부여가 사라져도 시스템은 남는다.',
        '성공은 매일매일 다른 행동을 요구한다.',
        '일관성은 기분보다 중요하다.'
      ], answer:2};
      return {passage, questions:[q1,q2,q3]};
    }

    function renderRC(keyword,len){
      const {passage,questions} = makePassage(keyword,len);
      const box = $$('#rcPassage'); box.innerHTML='';
      const p = document.createElement('div');
      p.innerHTML = `<div class="mut tiny">* 생성된 연습 지문 — 키워드: <b>${keyword}</b></div><div style="line-height:1.7">${passage.replaceAll(keyword, `<u>${keyword}</u>`)}</div>`;
      box.appendChild(p);
      questions.forEach((q,idx)=>{
        const c = document.createElement('div'); c.className='card'; c.style.background='#0d0d11'; c.style.borderStyle='dashed';
        c.innerHTML = `<div class="row" style="gap:10px"><span class="pill">Q${idx+1} | ${q.type}</span><div>${q.q}</div></div>`;
        q.options.forEach((opt,i)=>{
          const b=document.createElement('div'); b.className='opt'; b.textContent=`${i+1}. ${opt}`;
          b.onclick=()=>{
            $$$('.opt',c).forEach(el=>el.style.pointerEvents='none');
            if(i===q.answer){ b.classList.add('correct'); } else { b.classList.add('wrong'); }
          };
          c.appendChild(b);
        });
        box.appendChild(c);
      });
      saveHistorySession({mode:'RC', keyword, len});
    }

    // History
    function renderHistory(){
      const box = $$('#history'); box.innerHTML='';
      if(!state.history.sessions.length){ box.innerHTML='<div class="mut">기록 없음</div>'; return; }
      state.history.sessions.slice().reverse().forEach(s=>{
        const d=document.createElement('div'); d.className='row'; d.style.justifyContent='space-between';
        d.innerHTML = `<div class="pill"><b>${new Date(s.ts).toLocaleString()}</b></div>
          <div class="tiny">deck:${s.deckSize||'-'} | score:${s.score||0} | combo:${s.combo||0} | wrongs:${s.wrongs||0} ${s.keyword? '| kw:'+s.keyword:''}</div>`;
        box.appendChild(d);
      });
    }

    // INIT
    function rebuildDeck(){
      const n = Math.max(1, parseInt($$('#deckSize').value || '20'));
      state.deck = shuffle(state.words).slice(0,n);
      state.idx=0; showCard(); renderQuiz(); updateProgress();
    }

    function init(){
      // Tabs
      $$$('nav .tab').forEach(b=>b.onclick=()=>{ setTab(b.dataset.tab); if(b.dataset.tab==='test') renderQuiz(); });
      setTab('mem');

      // Load sample words initially
      state.words = SAMPLE_WORDS.slice();
      rebuildDeck();

      // Flashcards handlers
      $$('#flip').onclick=()=>{ const v=$$('#fcBack').style.display!=='none'; $$('#fcBack').style.display=v?'none':'block'; };
      $$('#next').onclick=()=>{ if(state.idx < state.deck.length-1){ state.idx++; showCard(); } };
      $$('#prev').onclick=()=>{ if(state.idx>0){ state.idx--; showCard(); } };
      document.addEventListener('keydown',e=>{ if(e.key==='ArrowRight') $$('#next').click(); if(e.key==='ArrowLeft') $$('#prev').click(); if(e.key===' ') $$('#flip').click(); });

      $$('#markEasy').onclick=()=>{ state.combo++; $$('#combo').textContent=state.combo; };
      $$('#markHard').onclick=()=>{ // push current word to end for repetition
        const w=state.deck[state.idx]; state.deck.push(w); updateProgress();
      };

      // Settings
      $$('#shuffleBtn').onclick=()=>{ state.deck = shuffle(state.deck); state.idx=0; showCard(); renderQuiz(); };
      $$('#resetBtn').onclick=()=>{ state.score=0; state.combo=0; state.wrongs=[]; $$('#score').textContent='0'; $$('#combo').textContent='0'; $$('#wrongs').textContent='0'; state.idx=0; showCard(); renderQuiz(); };
      $$('#deckSize').onchange=rebuildDeck;

      // Import
      $$('#importBtn').onclick=()=>{
        const txt = $$('#pasteBox').value.trim();
        const arr = txt? parseCSV(txt): [];
        mergeWords(arr);
      };
      $$('#fileInput').addEventListener('change', async (e)=>{
        const f = e.target.files[0];
        if(!f) return;
        try{
          const t = await readTextSmart(f);
          const rows = parseCSV(t);
          if(!rows.length){
            $$('#importMsg').textContent = '형식 인식 실패: "영단어,의미" 또는 탭/세미콜론 구분 텍스트를 사용하세요.';
            return;
          }
          mergeWords(rows);
        } catch(err){
          $$('#importMsg').textContent = '불러오기 실패: ' + err.message;
        }
      });

      // Test
      $$('#nextQ').onclick=()=>{ if(state.idx < state.deck.length-1){ state.idx++; renderQuiz(); showCard(); } else { saveHistorySession({mode:'TEST'}); alert('오늘의 덱 완료! 기록에 저장했습니다.'); } };
      $$('#retryWrong').onclick=()=>{ if(!state.wrongs.length){ alert('오답이 없습니다.'); return;} state.deck = state.wrongs.slice(); state.wrongs=[]; state.idx=0; renderQuiz(); showCard(); };

      // Sentence
      $$('#genSent').onclick=()=>{
        const w = ($$('#sentWord').value || (state.deck[state.idx]?.en) || '').trim();
        if(!w){ alert('단어를 입력하세요.'); return; }
        const ss = sentenceTemplates(w);
        const box = $$('#sentences'); box.innerHTML='';
        ss.forEach(o=>{ const c=document.createElement('div'); c.className='card'; c.style.background='#0d0d11'; c.style.borderStyle='dashed'; c.innerHTML=`<div>${o.en}</div><div class='mut'>${o.ko}</div>`; box.appendChild(c); });
        saveHistorySession({mode:'SENT', keyword:w});
      };

      // RC
      $$('#genRC').onclick=()=>{
        const w = ($$('#rcWord').value || (state.deck[state.idx]?.en) || '').trim();
        const len = Math.max(60, parseInt($$('#rcLen').value || '120'));
        if(!w){ alert('단어를 입력하세요.'); return; }
        renderRC(w,len);
      };

      // Click word to auto-set inputs
      document.addEventListener('click', (e)=>{
        if(e.target && e.target.id==='fcFront'){ const w=e.target.textContent; $$('#sentWord').value=w; $$('#rcWord').value=w; }
      });

      // History
      renderHistory();

      // Initial quiz render
      renderQuiz();
    }

    init();
  </script>
</body>
</html>
